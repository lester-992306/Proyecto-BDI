<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Biblioteca • org.lemus</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
<div class="container py-4">
  <h1 class="mb-3">Biblioteca • org.lemus</h1>

  <section class="card mb-3">
    <div class="card-body">
      <h5>Login</h5>
      <div class="row g-2 align-items-center">
        <div class="col-md-3"><input id="u" class="form-control" placeholder="usuario"></div>
        <div class="col-md-3"><input id="p" class="form-control" type="password" placeholder="contraseña"></div>
        <div class="col-md-3"><button class="btn btn-primary" onclick="login()">Iniciar sesión</button></div>
        <div class="col-md-3"><span id="loginMsg" class="fw-semibold"></span></div>
      </div>
    </div>
  </section>

  <section class="card mb-3">
    <div class="card-body">
      <h5>Buscar Libros</h5>
      <div class="input-group mb-2">
        <input id="q" class="form-control" placeholder="título o autor">
        <button class="btn btn-outline-secondary" onclick="buscar()">Buscar</button>
      </div>
      <table class="table table-sm" id="tblLibros">
        <thead class="table-secondary"><tr>
          <th>ID</th><th>Título</th><th>Autor</th><th>Año</th><th>Género</th>
          <th>Totales</th><th>Disp.</th><th style="width:120px">Acciones</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <section class="card mb-3">
    <div class="card-body">
      <h5>Nuevo Libro</h5>
      <div class="row g-2">
        <div class="col"><input id="t" class="form-control" placeholder="Título"></div>
        <div class="col"><input id="a" class="form-control" placeholder="Autor"></div>
        <div class="col"><input id="y" class="form-control" type="number" placeholder="Año"></div>
        <div class="col"><input id="g" class="form-control" placeholder="Género"></div>
        <div class="col"><input id="ct" class="form-control" type="number" placeholder="Copias"></div>
        <div class="col"><button class="btn btn-success" onclick="crear()">Guardar</button></div>
      </div>
      <div><small id="crearMsg" class="text-success"></small></div>
    </div>
  </section>
</div>

<script>
async function login(){
  const r = await fetch('/api/login', {method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({username:document.getElementById('u').value, password:document.getElementById('p').value})});
  const m = document.getElementById('loginMsg');
  if(r.ok){
    const data = await r.json();
    if(data.ok){ m.textContent = 'Autenticado: ' + data.user.NOMBRE + ' (' + data.user.ROL + ')'; m.className='text-success fw-semibold'; }
    else { m.textContent = data.error || 'Credenciales inválidas'; m.className='text-danger fw-semibold'; }
  } else { m.textContent = 'Error de servidor'; m.className='text-danger fw-semibold'; }
}

async function buscar(){
  const q = document.getElementById('q').value;
  const r = await fetch('/api/libros?q='+encodeURIComponent(q));
  const data = await r.json();
  const tb = document.querySelector('#tblLibros tbody');
  tb.innerHTML = '';
  data.forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${x.libroId}</td>
      <td><input class="form-control form-control-sm" value="${x.titulo}" data-f="titulo"></td>
      <td><input class="form-control form-control-sm" value="${x.autor}" data-f="autor"></td>
      <td><input class="form-control form-control-sm" type="number" value="${x.anioPublicacion}" data-f="anioPublicacion"></td>
      <td><input class="form-control form-control-sm" value="${x.genero||''}" data-f="genero"></td>
      <td><input class="form-control form-control-sm" type="number" value="${x.copiasTotales}" data-f="copiasTotales"></td>
      <td><input class="form-control form-control-sm" type="number" value="${x.copiasDisponibles}" data-f="copiasDisponibles"></td>
      <td class="d-flex gap-1">
        <button class="btn btn-sm btn-outline-primary" onclick="guardar(${x.libroId}, this)">Guardar</button>
        <button class="btn btn-sm btn-outline-danger" onclick="eliminar(${x.libroId})">Eliminar</button>
      </td>`;
    tb.appendChild(tr);
  });
}

async function crear(){
  const body = {titulo:val('t'), autor:val('a'),
                anioPublicacion:Number(val('y')), genero:val('g'),
                copiasTotales:Number(val('ct')), copiasDisponibles:Number(val('ct'))};
  const r = await fetch('/api/libros',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  const msg = document.getElementById('crearMsg');
  if(r.ok){ msg.textContent='Libro creado'; limpiarNuevo(); buscar(); }
  else { const e = await r.json().catch(()=>({})); msg.textContent=e.error||'Error al crear'; msg.className='text-danger'; }
}

async function guardar(id, btn){
  const tr = btn.closest('tr');
  const get=(f)=>tr.querySelector(`[data-f="${f}"]`).value;
  const body = {titulo:get('titulo'), autor:get('autor'),
                anioPublicacion:Number(get('anioPublicacion')), genero:get('genero'),
                copiasTotales:Number(get('copiasTotales')), copiasDisponibles:Number(get('copiasDisponibles'))};
  const r = await fetch('/api/libros/'+id,{method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  if(r.ok){ btn.classList.replace('btn-outline-primary','btn-success'); btn.textContent='OK'; setTimeout(()=>{btn.classList.replace('btn-success','btn-outline-primary'); btn.textContent='Guardar';}, 900); }
  else { alert('Error al actualizar'); }
}

async function eliminar(id){
  if(!confirm('¿Eliminar libro?')) return;
  const r = await fetch('/api/libros/'+id,{method:'DELETE'});
  if(r.ok){ buscar(); } else { alert('No se pudo eliminar (quizá tiene préstamos activos)'); }
}

function val(id){ return document.getElementById(id).value; }
function limpiarNuevo(){ ['t','a','y','g','ct'].forEach(i=>document.getElementById(i).value=''); }
</script>
</body>
</html>
